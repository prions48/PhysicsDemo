@using MudBlazor.Charts
@using System.Text.Json
@using PhysicsDemo.Data.GameData
@using ApexCharts
@using QRCoder
@using Color = MudBlazor.Color
@using PhysicsDemo.Data.WebHooks
@implements IDisposable
@inject ISnackbar Snackbar
@inject PhysicsService physicsService
@inject WebHookService webhookService
@inject NavigationManager navManager

@if (SelectedGame.NumPlayers > SelectedGame.Players.Count)
{
    <MudStack>
        <MudAlert Severity="Severity.Warning">Waiting for players to join</MudAlert>
        <MudProgressLinear Indeterminate />
        <MudText Typo="Typo.h3">Join Code: @SelectedGame.JoinCode</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="Refresh">Refresh</MudButton>
        @if (!string.IsNullOrWhiteSpace(QRCodeImg))
        {
            <img src="@QRCodeImg" width="150" />
        }
    </MudStack>
}
else
{
    <MudGrid>
        <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
            <MudText Style="font-weight: bold;">@SelectedGame.JoinCode</MudText>
        </MudItem>
        @if (SelectedGame.MidPoint.HasValue)
        {
            <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
                <MudChip Color="SelectedGame.Players.Any(e => e.PassedMidpoint == true) ? Color.Info : Color.Default" T="string">Midpoint: @SelectedGame.MidPoint.ToString()</MudChip>
            </MudItem>
        }
        @if (SelectedGame.EndPoint.HasValue)
        {
            <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
                <MudChip Color="SelectedGame.Players.Any(e => e.PassedEndpoint == true) ? Color.Success : Color.Default" T="string">Endpoint: @SelectedGame.EndPoint.ToString()</MudChip>
            </MudItem>
        }
        <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
            <MudButton OnClick="Refresh" Color="Color.Primary" Variant="Variant.Filled">Refresh</MudButton>
        </MudItem>
        @*<MudButton OnClick="TriggerRefresh" Color="Color.Secondary" Variant="Variant.Filled">Test</MudButton>*@
        <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
            <MudIconButton Color="Positive ? Color.Info : Color.Error" Icon="@(Positive ? Icons.Material.Filled.ArrowCircleRight : Icons.Material.Filled.ArrowCircleLeft)" OnClick="AddDirection" />
        </MudItem>
        <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
            <MudText>Direction: @(Positive ? "Right" : "Left")</MudText>
        </MudItem>
        @if (!string.IsNullOrWhiteSpace(Winner))
        {
            <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
                <MudText Typo="Typo.h4">@Winner</MudText>
            </MudItem>
        }
        @if (User is PhysicsGuestUser guest)
        {
            <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
                <MudText>PIN: @guest.Passcode</MudText>
            </MudItem>
        }
        <MudItem xs=4 sm=3 md=2 lg=1 xl=1>
            <MudButton Color="Color.Default" StartIcon="@Icons.Material.Filled.Home" Variant="Variant.Filled" OnClick="Reset">Home</MudButton>
        </MudItem>
    </MudGrid>
    <MudTabs>
        <MudTabPanel Text="My Moves">
            <MudSimpleTable Striped Bordered>
                <tbody>
                    <tr>
                        <td>@(TurnNumber)</td>
                        <td>
                            <MudNumericField @ref="ForceField" @bind-Value="NewForce" Label="Force" Style="width:200px;" Immediate @onkeydown="KeyPress" InputMode="InputMode.numeric" />
                        </td>
                        <td colspan="3">
                            <MudButton @ref="SubmitButton" Color="Color.Info" Variant="Variant.Filled" Disabled="!NewForce.HasValue || TurnNumber == MyMoves!.MaxTurn" OnClick="AddMove">Next Step</MudButton>
                        </td>
                    </tr>
                    <tr>
                        <td><b>Time</b></td>
                        <td><b>Force</b></td>
                        <td><b>Acceleration</b></td>
                        <td><b>Velocity</b></td>
                        <td><b>Position</b></td>
                    </tr>
                    @foreach (GameStepModel model in MyMoves!.Steps.OrderByDescending(e => e.Time))
                    {
                        <tr>
                            <td>@model.Time</td>
                            <td>
                                @if (model.Time == MyMoves.Steps.MaxBy(e => e.Time)?.Time)
                                {
                                    @if (Editing)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Success" OnClick="SaveEditMove" />
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Success" OnClick="EditMove" />
                                    }
                                }
                                @if (Editing && model.Time == MyMoves.Steps.Select(e => e.Time).Max())
                                {
                                    <MudNumericField HideSpinButtons @bind-Value="model.Force" />
                                }
                                else
                                {
                                    @model.Force.ToString()
                                }
                            </td>
                            <td>@model.Acceleration.ToString("N1")</td>
                            <td>@model.Velocity.ToString("N1")</td>
                            <td>@model.Position.ToString("N1")</td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        </MudTabPanel>
        <MudTabPanel Text="Graphs">
            @*<MudStack>
                <MudChart ChartType="ChartType.Line" ChartSeries="AccData" ChartOptions="_accoptions"></MudChart>
                <MudChart ChartType="ChartType.Line" ChartSeries="VecData" ChartOptions="_vecoptions"></MudChart>
                <MudChart ChartType="ChartType.Line" ChartSeries="PosData" ChartOptions="_posoptions"></MudChart>
            </MudStack>*@
            <MudStack>
                <MudSelect @bind-Value="GraphSize" Label="Graph Size Setting" T="string">
                    <MudSelectItem T="string" Value="@("100%")">Full Size</MudSelectItem>
                    <MudSelectItem T="string" Value="@("60%")">Large</MudSelectItem>
                    <MudSelectItem T="string" Value="@("40%")">Medium</MudSelectItem>
                    <MudSelectItem T="string" Value="@("20%")">Small</MudSelectItem>
                </MudSelect>
                <MudPaper Width="@GraphSize.ToString()">
                    <ApexChart TItem="GameStepModel" Title="Acceleration" Options="AccOptions">
                        @foreach (var move in Moves)
                        {
                            <ApexPointSeries TItem="GameStepModel" Items="move.Steps" Name="@(move.UserName)" SeriesType="SeriesType.Line" XValue="@(e => e.Time)" YValue="@(e => (decimal)e.Acceleration)" ShowDataLabels />
                        }
                    </ApexChart>
                </MudPaper>
                <MudPaper Width="@GraphSize.ToString()">
                    <ApexChart TItem="GameStepModel" Title="Velocity" Options="VecOptions">
                        @foreach (var move in Moves)
                        {
                            <ApexPointSeries TItem="GameStepModel" Items="move.Steps" Name="@(move.UserName)" SeriesType="SeriesType.Line" XValue="@(e => e.Time)" YValue="@(e => (decimal)e.Velocity)" ShowDataLabels />
                        }
                    </ApexChart>
                </MudPaper>
                <MudPaper Width="@GraphSize.ToString()">
                    <ApexChart TItem="GameStepModel" Title="Position" Options="PosOptions">
                        @foreach (var move in Moves)
                        {
                            <ApexPointSeries TItem="GameStepModel" Items="move.Steps" Name="@(move.UserName)" SeriesType="SeriesType.Line" XValue="@(e => e.Time)" YValue="@(e => (decimal)e.Position)" ShowDataLabels />
                        }
                    </ApexChart>
                </MudPaper>
            </MudStack>
        </MudTabPanel>
    </MudTabs>
}

<MudDialog @bind-Visible="ShowPIN" Options="Options">
    <DialogContent>
        @if (User is PhysicsGuestUser guest)
        {
            <MudText>Your PIN to rejoin this game is <b>@guest.Passcode</b></MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="() => ShowPIN = false">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter, EditorRequired] public IUser User { get; set; }
    [Parameter, EditorRequired] public PhysicsGame SelectedGame { get; set; }
    [Parameter] public bool ShowPIN { get; set; } = false;
    private DialogOptions Options { get; set; } = new() { CloseOnEscapeKey = true };
    private string GraphSize { get; set; } = "100%";
    private List<UserMoves> Moves { get; set; } = [];
    private PhysicsPlayer? MyPlayer => SelectedGame.Players.FirstOrDefault(e => e.PlayerID == User.UserID);
    private UserMoves? MyMoves => Moves.FirstOrDefault(e => e.UserID == User.UserID);
    private int TurnNumber { get; set; } = 1;
    private bool Positive { get; set; } = true;
    //private int DirectionFactor => Positive ? 1 : -1;
    private int? NewForce { get; set; } = null;
    private MudNumericField<int?> ForceField { get; set; } = default!;
    private MudButton SubmitButton { get; set; } = default!;
    private ApexChartOptions<GameStepModel> AccOptions { get; set; } = new ApexChartOptions<GameStepModel> { Stroke = new Stroke { Curve = Curve.Stepline }, Chart = new Chart { Type = ApexCharts.ChartType.Line, Zoom=new() { AllowMouseWheelZoom=false, Enabled=false} } };
    private ApexChartOptions<GameStepModel> VecOptions { get; set; } = new ApexChartOptions<GameStepModel> { Stroke = new Stroke { Curve = Curve.Smooth }, Chart = new Chart { Type = ApexCharts.ChartType.Line, Zoom=new() { AllowMouseWheelZoom=false, Enabled=false} } };
    private ApexChartOptions<GameStepModel> PosOptions { get; set; } = new ApexChartOptions<GameStepModel> { Stroke = new Stroke { Curve = Curve.Smooth }, Chart = new Chart { Type = ApexCharts.ChartType.Line, Zoom=new() { AllowMouseWheelZoom=false, Enabled=false} } };
    protected override async Task OnInitializedAsync()
    {
        GenerateQRCode();
        await Refresh();
        webhookService.OnWebhookReceived += OnWebHookReceived;
        await TriggerRefresh();
    }
    public void Dispose()
    {
        webhookService.OnWebhookReceived -= OnWebHookReceived;
    }
    //private string Payload { get; set; } ="";
    private async void OnWebHookReceived(string body)
    {
        //Payload = body;
        WebhookEvent? payload = JsonSerializer.Deserialize<WebhookEvent>(body);
        if (payload != null)
        {
            if (payload.GameID == SelectedGame.ID)
            {
                if (payload.UserID != User.UserID)
                {
                    Snackbar.Add($"Move by {payload.PlayerName}!", Severity.Info);
                }
                await Refresh();
            }
        }
    }
    private async Task KeyPress(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            if (NewForce.HasValue && TurnNumber > MyMoves!.MaxTurn)
            {
                await AddMove();
            }
        }
    }
    private string? Winner = null;
    private void Reset()
    {
        navManager.NavigateTo("/",true);
    }
    private async Task TriggerRefresh()
    {
        WebhookEvent payload = new(){
            GameID = SelectedGame.ID,
            UserID = User.UserID,
            PlayerName = MyPlayer?.PlayerName ?? "Unknown"
        };
        bool result = await webhookService.SendWebhookAsync(payload);
        if (!result)
        {
            Snackbar.Add("Network Connectivity Problems (tm).", Severity.Error);
        }
        //Refresh();//replaced by webhook above
    }
    private async Task Refresh()
    {
        PhysicsGame? game = physicsService.GetGameByID(SelectedGame.ID);
        if (game != null)
        {
            TurnNumber = SelectedGame.CurrentRound;
            Moves = [];
            foreach (PhysicsPlayer player in SelectedGame.Players)
            {
                UserMoves moves = new UserMoves() { UserID = player.PlayerID, UserName = player.PlayerName ?? "Unknown", Steps = RecalculateSteps(player) };
                int? midindex = null;
                if (game.MidPoint != null)
                {
                    for (int i = 0; i < moves.Steps.Count; i++)
                    {
                        if (moves.Steps[i].Position >= game.MidPoint)
                        {
                            midindex = i;
                            player.PassedMidpoint = true;
                            physicsService.UpdatePlayer(player);
                            break;
                        }
                    }
                }
                if (game.EndPoint != null && midindex != null)
                {
                    for (int i = midindex.Value+1; i < moves.Steps.Count; i++)
                    {
                        if (moves.Steps[i].Position <= game.EndPoint)
                        {
                            //a winner is you (or someone)
                            player.PassedEndpoint = true;
                            physicsService.UpdatePlayer(player);
                            if (game.GameEnd == null)
                            {
                                game.GameEnd = DateTime.Now;
                                physicsService.UpdateGame(game);
                            }
                            break;
                        }
                    }
                }
                Moves.Add(moves);
            }
            Positive = MyPlayer?.Directions.Count % 2 == 0;
            SetDirectionGraph();
            if (game.GameEnd != null)
            {
                List<PhysicsPlayer> players = game.Players.Where(e => e.PassedEndpoint == true).ToList();
                if (players.Count == 1)
                {
                    game.WinningPlayerID = players.First()!.PlayerID;
                    physicsService.UpdateGame(game);
                    Snackbar.Add(players.First().PlayerName + " has won the game!", Severity.Success);
                }
            }
            if (game.WinningPlayerID != null)
            {
                PhysicsPlayer? player = game.Players.FirstOrDefault(e => e.PlayerID == game.WinningPlayerID);
                if (player != null)
                    Winner = "Winner: " + player.PlayerName;

            }
            SelectedGame = game;
            NewForce = null;
        }
        else
        {
            Snackbar.Add("Game not found, please wait and retry.", Severity.Error);
        }
        await InvokeAsync(StateHasChanged);
    }
    private List<GameStepModel> RecalculateSteps(PhysicsPlayer player)
    {
        List<PhysicsTurn> turns = player.Turns;
        List<GameStepModel> models = [new GameStepModel()];
        foreach (PhysicsTurn turn in turns)
        {
            models.Add(new(models.Last(),turn));
        }
        return models;
    }
    private async Task AddMove()
    {
        if (NewForce == null || MyPlayer == null || MyMoves == null)
            return;
        await SubmitButton.FocusAsync();
        PhysicsTurn turn = new()
        {
            GameID = SelectedGame.ID,
            PlayerID = User.UserID,
            CreatedTimeStamp = DateTime.Now,
            TurnValue = NewForce.Value,
            RoundNumber = TurnNumber
        };
        physicsService.CreateTurn(turn);
        MyPlayer.Turns.Add(turn);
        //MyMoves.Steps.Add(new(MyMoves.Steps.Last(),turn));
        NewForce = null;
        await TriggerRefresh();
        await ForceField.FocusAsync();
        StateHasChanged();
    }
    private void AddDirection()
    {
        PhysicsDirection direction = new()
        {
            GameID = SelectedGame.ID,
            PlayerID = User.UserID,
            TurnValue = TurnNumber
        };
        physicsService.CreateDirection(direction);
        if (MyPlayer != null)
        {
            MyPlayer.Directions.Add(direction);
        }
        Positive = !Positive;
        SetDirectionGraph();
    }
    private void SetDirectionGraph()
    {
        List<AnnotationsXAxis> annotations = [];
        Dictionary<double,int> valcount = [];
        foreach (PhysicsPlayer player in SelectedGame.Players)
        {
            foreach (PhysicsDirection direction in player.Directions)
            {
                valcount.TryAdd(direction.TurnValue,0);
                valcount[direction.TurnValue]++;
                annotations.Add(new() {
                    Label = new() { Text = $"Turnaround for {player.PlayerName}", Style = new() { Background = "white", Color="black"} },
                    X = (double)direction.TurnValue + ((valcount[direction.TurnValue]-1) * 0.1)
                });
            }
        }
        AccOptions.Annotations = new() { Xaxis = annotations };
    }
    public class UserMoves
    {
        public Guid UserID { get; set; }
        public string UserName { get; set; } = "";
        public List<GameStepModel> Steps { get; set; } = [];
        public int MaxTurn => Steps.Count == 0 ? 0 : Steps.Select(e => e.Time).Max();
    }
    private bool Editing { get; set; } = false;
    private void EditMove()
    {
        Editing = true;
    }
    private async Task SaveEditMove()
    {
        if (MyPlayer != null && MyMoves != null)
        {
            var turn = MyPlayer.Turns.MaxBy(e => e.RoundNumber);
            if (turn != null)
            {
                turn.TurnValue = MyMoves.Steps.MaxBy(e => e.Time)?.Force ?? 0;
                physicsService.UpdateTurn(turn);
                await Refresh();
            }
        }
        Editing = false;
    }
    private string? QRCodeImg { get; set; } = null;
    private void GenerateQRCode()
    {
        if (SelectedGame.NumPlayers <= SelectedGame.Players.Count)
            return;
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrData = qrGenerator.CreateQrCode($"https://physicsdemo.azurewebsites.net/{SelectedGame.ID}",QRCodeGenerator.ECCLevel.Q);
        using (BitmapByteQRCode qrCode = new BitmapByteQRCode(qrData))
        {
            byte[] qrImg = qrCode.GetGraphic(20);
            string base64 = Convert.ToBase64String(qrImg);
            QRCodeImg = string.Format("data:image/png;base64,{0}", base64);
        }
    }

}